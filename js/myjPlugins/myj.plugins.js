function end(){paper.createTextNode({data:$("#freeText").val(),textPath:textPath.toString()});textElementProp[currentTextIndex].curverPath=textPath.toString()}function move(e,t){this.update(e-(this.dx||0),t-(this.dy||0));this.dx=e;this.dy=t}function up(){this.dx=this.dy=0}function showAllHandles(){if(typeof freetransform!="undefined"&&freetransform.length>0)for(var e=0;e<freetransform.length;e++){freetransform[e].showHandles()}}function hideOutsideLetters(){var e=bleedingBox[currentTextIndex];for(var t=0;t<raphaelText[currentTextIndex].length;t++){var n=raphaelText[currentTextIndex][t].getBBox();if(e.isPointInside(Math.round(n.x),Math.round(n.y))&&e.isPointInside(Math.round(n.x),Math.round(n.y)+n.height)){raphaelText[currentTextIndex][t].attr("opacity",1)}else{raphaelText[currentTextIndex][t].attr("opacity",.2)}}}function changeColor(e){for(var t=0;t<raphaelText[currentTextIndex].length;t++){raphaelText[currentTextIndex][t].attr({fill:e})}textElementProp[currentTextIndex].color=e}function hideAllBboxes(){if(typeof freetransform!="undefined"&&freetransform.length>0)for(var e=0;e<freetransform.length;e++){if(freetransform[e]!="undefined")freetransform[e].hideHandles({undrag:false})}}function hideAllHandles(){if(typeof freetransform!="undefined"&&freetransform.length>0)for(var e=0;e<freetransform.length;e++){if(freetransform[e].valueOf()!="undefined")freetransform[e].hideHandles({undrag:false})}}function removetextElm(e){freetransform[e].unplug();freetransform[e]="undefined";for(var t=0;t<raphaelText[e].length;t++){raphaelText[e][t].remove()}bleedingBox[e].remove()}function unfocusText(){$("#onlyTextTools").slideUp();for(var e=0;e<bleedingBox.length;e++){bleedingBox[e].hide()}$(".custClose").hide();hideAllHandles()}function loadsvgicon(e,t){$(".close_popupdiv").trigger("click");$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var t=paper.importSVG(e).attr("stroke-width",0);t.transform("T10,20");var n=t.getBBox();var r=n.width;var i=paper.circle(n.x+n.width,n.y-10,8).attr({fill:"#FF002E"});var s=paper.text(n.x+n.width,n.y-11,"x").attr({fill:"#fff","font-size":14});var o=paper.set();o.push(s,i);var u=paper.freeTransform(t,{draw:["bbox"]},function(e,t){if(t=="drag start"){o.hide()}for(var n=0;n<t.length;n++){if(t[n]=="rotate end"||t[n]=="scale end"||t[n]=="animate end"||t[n]=="drag end"){var i=this.handles.bbox[1].element;var s=i.getBBox();i.attr("fill","red");o.transform("T"+(s.x-r)+","+s.y);o.show();hideOutsideLetters()}}});o.click(function(){if(confirm("Are you sure you want to remove this icon ?")){t.remove();u.unplug();for(var e=0;e<o.length;e++){o[e].remove()}}})}})}function createBleedingBox(e){var t=$("#canvas").offset();paper.insertpath({xpos:e.pageX-t.left,ypos:e.pageY-t.top,pth:bleedingBox[currentTextIndex],event:e,complete:function(){$(".initialSteps").slideUp();$("#closeHints").trigger("click");$("#textTools").slideDown(function(){$("#onlyTextTools").slideDown(function(){paper.createTextNode({path:bleedingBox[currentTextIndex],index:indexKeeper});indexKeeper++;$canvas.css("cursor","default");setHtmlValues()})});$(".custClose").fadeIn()}})}function setHtmlValues(){$("#font_family").val(textElementProp[currentTextIndex].fontFamily);$("#lineSpacingSel").val(textElementProp[currentTextIndex].lineSpacing);$("#colorPicker").val(textElementProp[currentTextIndex].color.split("#")[1]);$("#colorPicker").css({"background-color":textElementProp[currentTextIndex].color,color:"#fff"})}function exportToJSON(){var e=new Object;for(var t=0;t<textElementProp.length;t++){e[t]=new Object;$.each(textElementProp[t],function(n,r){e[t][n]=r})}var n=JSON.stringify(e);$.ajax({type:"POST",url:"http://localhost:8080/myj_new/test",data:n,success:alert("Sucessfully saved")})}var initialPos=[],globalcount=0,raphaelText=[],freetransform=[],globalX=[],globalY=[],t,curElmIndex,textPath,currentTextIndex=0,indexKeeper=0,bleedingBox=[],boundingcircle=[],paper,curverPaper,ptStr=[],rootrect,curve,straightPath,textElementProp=[];(function(e){e.fn.loadSvg=function(t,n){var r=e(this);t=jQuery.extend({url:"",ppr:paper},t);e.ajax({type:"GET",url:t.url,dataType:"xml",success:function(r){t.ppr.clear();t.ppr.importSVG(r);rootrect=paper.rect(0,0,paper.width,paper.height).attr({fill:"#000000",opacity:.7,"stroke-width":1,stroke:"#fff","text-anchor":"start"});setTimeout(function(){drawingAreatxtMsg=paper.text(380,e("#canvas").height()/2-10,"Click on the 'Add New Text' button to start customizing.").attr({fill:"#fff","stroke-widht":0,"font-size":22})},300);if(typeof n=="function"){n.call(this)}}})}})(jQuery);Raphael.fn.insertpath=function(e,t){e=e||{};var n={xpos:e.xpos||-1,ypos:e.ypos||-1,complete:e.complete||null,pth:e.pth||null,event:e.event};var r={"fill-opacity":.3,fill:"#fff"};if(n.xpos<0||n.ypos<0||n.pth==null){alert("options cant be undefined - insertpath"+n.xpos+":"+n.ypos+":"+n.pth);return}var i=Math.round(n.xpos);var s=Math.round(n.ypos);ptStr[currentTextIndex]=n.pth.attr("path").toString();if(ptStr[currentTextIndex]==""){initialPos[0]=i;initialPos[1]=s;ptStr[currentTextIndex]="M"+i+","+s;if(typeof boundingcircle[currentTextIndex]=="undefined"||boundingcircle[currentTextIndex]==""){var o=this.circle(i,s,6).attr({fill:"#fff","stroke-width":1,stroke:"#000000"});var u="";o.click(function(){var e=this;if(confirm("Are you done with the Bleeding Area ?")){u="L"+initialPos[0]+","+initialPos[1];n.pth.attr("path",n.pth.attr("path").toString()+u).attr(r);e.remove();setTimeout(function(){$canvas.off("click");$canvas.unbind("click")},500);if(typeof n.complete=="function"){n.complete.call(this)}return}else{n.pth.attr("path","");e.remove();boundingcircle[currentTextIndex]="";$canvas.off("click");setTimeout(function(){$canvas.on("click",function(e){createBleedingBox(e)})},1e3);return}})}}ptStr[currentTextIndex]+="L"+i+","+s;n.pth.attr("path",ptStr[currentTextIndex]).attr(r)};var _printOnPath=function(e,t,n){if(typeof n=="string")n=t.path(n).attr({stroke:"none"});for(var r=0;r<e.length;r++){var i=e[r];var s=n.getPointAtLength(i.getBBox().x);var o=i.transform()+"T"+(s.x-i.getBBox().x)+","+(s.y-i.getBBox().y-i.getBBox().height);o+="R"+(s.alpha<360?180+s.alpha:s.alpha);i.transform(o)}};Raphael.fn.printLetters=function(e,t,n,r,i,s,o,u){s=s||i/1.5;o=o||i;this.setStart();var a=e,f=t;for(var l=0;l<n.length;l++){var c=n.charAt(l);if(c!="\n"){var h=this.print(a,f,c,r,i);if(c==c.toUpperCase())a+=h.getBBox().width-s*1.5;if(c==" ")a+=s;a+=s}else{a=e;f+=o}}var p=this.setFinish();if(u){_printOnPath(p,this,u)}return p};var _width,_height;Raphael.fn.curver=function(e,t,n,r,i,s,o,u,a,f){_width=f.width-20;_height=f.height/2;var l={fill:"#fff",stroke:"none"};var c={fill:"90-#e5a302-#f8d202",stroke:"none"};straightPath=[["M",e,t],["C",n,r,i,s,o,u]];textPath=[["M",e,t],["C",n,r,i,s,o,u]],path2=[["M",e,t],["L",n,r],["M",i,s],["L",o,u]],curve=f.path(textPath).attr({stroke:a||Raphael.getColor(),"stroke-width":4,"stroke-linecap":"round"}),controls=f.set(f.path(path2).attr({stroke:"#ccc","stroke-dasharray":". "}),f.circle(e,t,5).attr(l),f.circle(n,r,5).attr(c),f.circle(i,s,5).attr(c),f.circle(o,u,5).attr(l));controls[1].update=function(e,t){var n=this.attr("cx")+e,r=this.attr("cy")+t;if(n>2&&n<305&&r>10&&r<160){this.attr({cx:n,cy:r});textPath[0][1]=n;textPath[0][2]=r;path2[0][1]=n;path2[0][2]=r;controls[2].update(e,t)}};controls[2].update=function(e,t){var n=this.attr("cx")+e,r=this.attr("cy")+t;if(n>2&&n<305&&r>10&&r<160){this.attr({cx:n,cy:r});textPath[1][1]=n;textPath[1][2]=r;path2[1][1]=n;path2[1][2]=r;curve.attr({path:textPath});controls[0].attr({path:path2})}};controls[3].update=function(e,t){var n=this.attr("cx")+e,r=this.attr("cy")+t;if(n>2&&n<305&&r>10&&r<160){this.attr({cx:n,cy:r});textPath[1][3]=n;textPath[1][4]=r;path2[2][1]=n;path2[2][2]=r;curve.attr({path:textPath});controls[0].attr({path:path2})}};controls[4].update=function(e,t){var n=this.attr("cx")+e,r=this.attr("cy")+t;if(n>2&&n<305&&r>10&&r<160){this.attr({cx:n,cy:r});textPath[1][5]=n;textPath[1][6]=r;path2[3][1]=n;path2[3][2]=r;controls[3].update(e,t)}};controls.drag(move,up,end)};Raphael.fn.createTextNode=function(options,callback){options=options||{};var opts={fontSize:options.fontSize||18,data:options.data||$("#freeText").val()||"Enter Text",fontFamily:options.fontFamily||$("#font_family").val()||"MyriadProRegular",letterSpacing:options.letterSpacing||5,path:options.path||bleedingBox[currentTextIndex],index:options.index||currentTextIndex,color:options.color||(typeof textElementProp[currentTextIndex]!="undefined"?textElementProp[currentTextIndex].color:"#000000"),textPath:options.textPath||straightPath.toString(),lineSpacing:options.lineSpacing||10,x:options.x||0,y:options.y||0};if(opts.path==""){alert("Error ! path string cannot be undefined. fn createTextNode");return}console.log(opts);var initPos=[];var bbox;if(typeof opts.path=="string"){bleedingBox[opts.index]=paper.path(opts.path.toString()).attr({"stroke-width":2,stroke:"#3EEFC6"});bbox=bleedingBox[opts.index].getBBox()}else{bbox=opts.path.getBBox()}if(typeof globalX[curindex]=="undefined"){initPos[0]=bbox.x+bbox.width/2;initPos[1]=bbox.y+bbox.height/2}var curindex=opts.index;var pth=this.path(opts.textPath).attr("stroke","none"),message=opts.data,message_length=[];var places=[],ratio=[],fontsize=[];if(typeof raphaelText[curindex]!="undefined"){for(var x=0;x<raphaelText[curindex].length;x++){raphaelText[curindex][x].remove()}freetransform[curindex].unplug()}var lines=opts.data.split(/\r\n|\r|\n/g);var ix=0;raphaelText[curindex]=paper.set();for(var l=0;l<lines.length;l++){places[l]=[];var trailLength=0;message_length[l]=0;for(var c=0;c<lines[l].length;c++){var letter=paper.print(0,0,lines[l][c],paper.getFont(opts.fontFamily),30);letter.data("index",curindex);raphaelText[curindex].push(letter);places[l].push(trailLength);if(lines[l][c]==" "){message_length[l]+=5}else if(lines[l][c]=="T"){message_length[l]+=letter.getBBox().width-opts.fontSize/3.5;trailLength+=letter.getBBox().width-opts.fontSize/3.5}else{message_length[l]+=Math.max(4,letter.getBBox().width);trailLength+=Math.max(4,letter.getBBox().width)}message_length[l]+=opts.letterSpacing;trailLength+=opts.letterSpacing}ratio[l]=pth.getTotalLength()/message_length[l];fontsize[l]=10*ratio[l]}var bbox=raphaelText[curindex][0].getBBox();var ylen=0;for(var l=0;l<lines.length;l++){var pLen=pth.getTotalLength();for(var c=0;c<lines[l].length;c++){raphaelText[curindex][ix].attr({"font-size":fontsize[l]+"px",fill:opts.color});var p=pth.getPointAtLength(places[l][c]*ratio[l]);var adjustedX=p.x*message_length[l]/pLen;console.log(adjustedX);if(typeof globalX[curindex]=="undefined"){raphaelText[curindex][ix].transform("T"+adjustedX+","+(p.y+ylen)+"R"+(p.alpha<=180?p.alpha+180:p.alpha))}else{raphaelText[curindex][ix].transform("T"+(adjustedX+globalX[curindex])+","+(p.y+globalY[curindex]+ylen)+"R"+(p.alpha<=180?p.alpha+180:p.alpha))}ix++}ylen+=bbox.height+opts.lineSpacing}raphaelText[curindex].mouseover(function(){this.attr({stroke:"#ddd","stroke-width":1})});raphaelText[curindex].mouseout(function(){this.attr("stroke-width",0)});if(typeof textElementProp[curindex]=="undefined"){textElementProp[curindex]={fontFamily:opts.fontFamily,fontSize:opts.fontSize,color:opts.color,curverPath:opts.textPath.toString(),lineSpacing:opts.lineSpacing,letterSpacing:opts.letterSpacing,bleedingBoxPath:bleedingBox[currentTextIndex].realPath.toString()}}else{for(var x in textElementProp[curindex]){if(x=="fontFamily"||x=="lineSpacing")if(textElementProp[curindex][x]!=opts[x])eval("textElementProp[curindex]."+x+"= opts[x]")}}if(textElementProp.length>0){$("#saveAndClose").show();$("#saveAndClose").addClass("animated swing")}console.log(freetransform[curindex]);console.log(raphaelText[curindex]);freetransform[curindex]=paper.freeTransform(raphaelText[curindex],{attrs:{fill:"#1898B6"},draw:["bbox"]},function(e,t){curve.attr("path",opts.textPath);if(t=="drag start"){$(".textTools").slideDown();$(".custClose").show().css("opacity",1);$("#freeText").blur();$(".initialSteps").hide()}e.subject[0].data("index",curindex);for(var n=0;n<t.length;n++){if(t[n]=="rotate end"||t[n]=="scale end"||t[n]=="animate end"||t[n]=="drag end"){if(t[n]=="drag end"){if(e.attrs.translate.x!=0){globalX[curindex]=e.attrs.translate.x+e.attrs.x-(initPos[0]-70)}if(e.attrs.translate.y!=0){globalY[curindex]=e.attrs.translate.y+e.attrs.y-initPos[1]}$("#onlyTextTools").slideDown("fast")}hideAllBboxes();this.showHandles({undrag:false});curve.attr("path",textElementProp[curindex].curverPath);bleedingBox[this.subject[0].data("index")].show();currentTextIndex=opts.index;textElementProp[curindex].scale=e.attrs.scale;textElementProp[curindex].rotate=e.attrs.rotate;hideOutsideLetters();setHtmlValues()}}var r=raphaelText[curindex].getBBox()});var previousRotate=textElementProp[curindex].rotate;var previousScale=textElementProp[curindex].scale;if(typeof previousRotate!="undefined"){freetransform[curindex].attrs.rotate=previousRotate}if(typeof previousRotate!="undefined"){freetransform[curindex].attrs.scale.x=previousScale.x;freetransform[curindex].attrs.scale.y=previousScale.y}freetransform[curindex].attrs.translate.x=initPos[0]-70;freetransform[curindex].attrs.translate.y=initPos[1]-30;freetransform[curindex].apply();curve.attr("path",opts.textPath.toString());hideOutsideLetters()};var _msg;$("#freeText").keyup(function(e){var n=this;clearTimeout(t);t=setTimeout(function(){paper.createTextNode({data:$(n).val(),textPath:textElementProp[currentTextIndex].curverPath})},500)})